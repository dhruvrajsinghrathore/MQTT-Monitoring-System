data_extraction_task:
  description: |
    Analyze the user query and extract relevant data from TDengine.
    
    Steps:
    0. FIRST: Extract cell IDs from the user query, then call get_tdengine_schema tool with those cell IDs to get schema information.
       - Extract all cell mentions from query (handle variations: "cell1", "cell 1", "cell_1", "cell one", etc.)
       - Normalize to "cell_N" format (e.g., "cell1" → "cell_1", "cell 2" → "cell_2")
       - This provides table structure, columns, sensors, and metadata needed to generate correct SQL queries
    
    1. Extract and normalize parameters:
       - Cell IDs: Extract from query, handle all formats ("cell1", "cell 1", "cell_1", "cell one", "first cell", etc.) and normalize to "cell_N"
       - Sensor names: Map @references to subtopic values using schema tool output, or discover sensor names from schema if mentioned in query
       - Time period: Extract from query - handle all formats:
         * Relative: "last X days/weeks/months/hours", "past X days", "X days ago"
         * Absolute: "January 1st 2025", "1st Nov 2025", "2025-11-01", "Nov 1 to Nov 9 2025", "between X and Y"
         * Relative points: "yesterday", "today", "this week", "this month"
         * Default to last 24 hours if not specified
       - Query intent: Determine if it's correlation, comparison, trend, current value, statistical analysis, etc.
    
    2. Time period handling:
       - ALWAYS include time filtering: ts >= 'YYYY-MM-DD HH:MM:SS' AND ts <= 'YYYY-MM-DD HH:MM:SS' (ISO format)
       - Parse natural language dates and convert to ISO format for SQL
       - For date ranges: Extract start and end dates, convert both to ISO format
       - If no time specified: Default to last 24 hours (NOW() - 24 HOUR)
       - Handle timezone considerations if mentioned
    
    3. Generate SQL queries:
       - Use schema information to identify correct tables and columns
       - Tables: cell_N format (discover dynamically from schema)
       - Columns: ts (timestamp), subtopic (sensor), reading (value), unit, sensor_type
       - Always include time filtering in WHERE clause
       - Support: JOINs, aggregations, WHERE conditions, date ranges, UNION ALL for multiple cells
       - Order: ts DESC for latest, ts ASC for chronological
    
    4. Statistical functions:
       - Correlation: Manual formula (AVG(x*y) - AVG(x)*AVG(y)) / (STDDEV(x) * STDDEV(y)) - TDengine may not support CORR()
       - Standard deviation: STDDEV(reading)
       - Variance: VAR(reading) or STDDEV(reading)^2
       - Covariance: AVG(x*y) - AVG(x)*AVG(y)
       - Other functions: AVG (mean), MIN, MAX, COUNT, SUM, PERCENTILE (median/quartiles), FIRST, LAST, RANGE (MAX-MIN)
       - Multi-cell statistical queries: If query asks for statistics "in cell1, cell2, cell5" (same sensor across multiple cells), calculate statistics PER CELL separately using UNION ALL, not combined. Return per-cell statistics in the statistics section.
       - Multi-sensor/cell comparisons: For comparisons between different sensors/cells, use JOINs on timestamp to align data, then calculate statistics or compare values
    
    5. Data extraction strategy:
       - Statistical queries (single or multiple cells): Calculate in SQL per cell if multiple cells, return only calculated values in statistics section (not raw data). Structure: {"cell_1": {"stddev": X, "mean": Y}, "cell_2": {...}}
       - Comparison queries: Fetch time-aligned data points using JOINs on timestamp, return in data section. If no time period specified, default to 24 hours and fetch aligned points for that period
       - Trend queries: Fetch historical points ordered chronologically, return in data section
       - Current value: ORDER BY ts DESC LIMIT 1, return in data section under "current"
    
    6. Execute query using execute_tdengine_query tool
    
    7. Return structured JSON:
       {
         "cells": ["cell_1", "cell_2", "cell_5", "cell_6"],
         "sensors": ["sensor_name"],
         "time_range": "description of time period used (e.g., 'November 1, 2025 to November 9, 2025')",
         "query_intent": "correlation" | "comparison" | "trend" | "current" | "statistical",
         "data": { /* time-aligned data points for comparisons/trends */ },
         "statistics": { /* For multi-cell: {"cell_1": {"stddev": X, "mean": Y, ...}, "cell_2": {...}}, For single: {"stddev": X, "mean": Y, ...} */ },
         "correlations": { /* correlation coefficients and covariance */ }
       }
  
  expected_output: "Structured JSON with cells, sensors, time_range (always include, default 24h if unspecified), query_intent, and appropriate data/statistics/correlations sections. For multi-cell statistical queries, statistics should be per-cell."

response_generation_task:
  description: |
    Using the extracted data from Agent 1, generate a clear natural language response.
    
    Agent 1 provides structured JSON with:
    - cells, sensors, time_range (always included, defaults to 24h if user didn't specify)
    - query_intent (correlation, comparison, trend, current, statistical)
    - data: For comparison queries without time period, Agent 1 defaults to 24h and returns time-aligned data points for mentioned sensors/cells. For trends, returns historical points. For current, returns latest value.
    - statistics: For single-cell queries: {"stddev": X, "mean": Y, ...}. For multi-cell queries: {"cell_1": {"stddev": X, "mean": Y, ...}, "cell_2": {...}} - only calculated values, not raw data
    - correlations: Correlation coefficients and covariance for correlation queries - only calculated values, not raw data
    
    Steps:
    1. Analyze Agent 1's output: Check time_range, query_intent, and relevant sections (data/statistics/correlations)
    
    2. Extract information based on query type:
       - Correlation: Coefficient from correlations section, explain meaning and strength
       - Statistical (single cell): Values from statistics section, explain each metric's meaning
       - Statistical (multiple cells): Extract per-cell statistics, compare values across cells, highlight which cells have higher/lower values
       - Comparison: Use time-aligned data points, highlight differences and patterns
       - Trend: Use historical data, describe direction and magnitude of change
       - Current: Use latest value from data section
    
    3. Generate response:
       - Answer directly in first sentence
       - Always mention time period analyzed
       - Include specific values with units
       - Explain statistical results in understandable terms
       - For multi-cell statistical queries: Present results per cell, compare across cells (e.g., "Cell 1 has stddev of X, Cell 2 has stddev of Y...")
       - For comparisons: Highlight key differences between cells/sensors
       - Keep concise (2-4 paragraphs)
       - Use clear, professional language
    
    4. If data insufficient: State what cannot be determined and why
    
    5. Format naturally: Answer → Details → Context
  
  expected_output: "Clear natural language response answering the query with specific values, time period context, and explanations of statistical analyses. For multi-cell queries, present per-cell results and comparisons."

